let appFilters={pageSize:25,pageNo:1,nameFilter:"",gender:0,minAge:0,maxAge:0,minDaysAfterLastCall:0,isFiltersNotChanged:function(){let n=parseInt($("#iPerPage").val()),t=$("#nameFilter").val(),i=parseInt($("#gender").val()),r=parseInt($("#minAge").val())||0,u=parseInt($("#maxAge").val())||0,f=parseInt($("#minDaysAfterLastCall").val())||0;return this.pageSize===n&&this.nameFilter===t&&this.gender===i&&this.minAge===r&&this.maxAge===u&&this.minDaysAfterLastCall===f},updateFilters:function(){appFilters.pageSize=parseInt($("#iPerPage").val());appFilters.nameFilter=$("#nameFilter").val();appFilters.gender=parseInt($("#gender").val());appFilters.minAge=parseInt($("#minAge").val())||0;appFilters.maxAge=parseInt($("#maxAge").val())||0;appFilters.minDaysAfterLastCall=parseInt($("#minDaysAfterLastCall").val())||0},getFiltersParamString:function(){let n="?";return n+="PageNo="+this.pageNo+"&PageSize="+this.pageSize,this.nameFilter&&(n+="&NameFilter="+encodeURIComponent(this.nameFilter)),this.gender!==0&&(n+="&Gender="+this.gender),this.minAge!==0&&(n+="&MinAge="+this.minAge),this.maxAge!==0&&(n+="&MaxAge="+this.maxAge),this.minDaysAfterLastCall!==0&&(n+="&MinDaysAfterLastCall="+this.minDaysAfterLastCall),n}},appState={currentPersonId:null,currentCallId:null,countOfRecords:0,getPagesCount:function(n){return this.countOfRecords<=n?1:this.countOfRecords%n==0?Math.floor(this.countOfRecords/n):Math.floor(this.countOfRecords/n)+1}},UIMap={personDetailTable:$("#tableUserDetail"),personCallsTable:$("#tableCallsHistory tbody"),personsListTable:$("#tableUsersList tbody"),pagesLabel:$("#pageLabel"),personsCountLabel:$("#personsCountLabel")},appQuery={loadPersonsDataList:function(n){$.ajax({url:"/api/persons"+appFilters.getFiltersParamString(),type:"GET",dataType:"json",success:function(t){n(t)},error:function(n,t,i){alert(n+"\n"+t+"\n"+i)}})},updateRecordsCount:function(n){$.ajax({url:"/api/persons/count"+appFilters.getFiltersParamString(),type:"GET",dataType:"json",success:function(t){n(t)},error:function(n,t,i){alert(n+"\n"+t+"\n"+i)}})},getPersonData:function(n,t){$.ajax({url:"/api/persons/"+n,type:"GET",dataType:"json",success:function(n){t(n)},error:function(n,t,i){alert(n+"\n"+t+"\n"+i)}})},getPersonColls:function(n,t){$.ajax({url:"/api/persons/"+n+"/calls",type:"GET",dataType:"json",success:function(n){t(n)},error:function(n,t,i){alert(n+"\n"+t+"\n"+i)}})},deletePerson:function(n,t){$.ajax({url:"/api/persons/"+n,type:"DELETE",contentType:"application/json; charset=utf-8",success:function(n){t(n)},error:function(n,t,i){alert(n+"\n"+t+"\n"+i)}})}},app={updatePagesLabel:function(){UIMap.pagesLabel.text("["+appFilters.pageNo+" стр. из "+appState.getPagesCount(appFilters.pageSize)+"]");$("#iPerPage").val(appFilters.pageSize)},loadPersonsList:function(){$("#loadingMsg").show();appState.currentPersonId="";appFilters.isFiltersNotChanged()||appFilters.updateFilters();appQuery.updateRecordsCount(function(n){appState.countOfRecords=n;UIMap.personsCountLabel.text("Всего найдено: "+n)});appQuery.loadPersonsDataList(function(n){UIMap.personsListTable.empty();$.each(n,function(n,t){let i='<tr id="'+t.id+'" onclick="app.selPerson(this);"> <td>'+(t.lastName===null?"":t.lastName)+"<\/td><td>"+t.firstName+"<\/td><td>"+(t.patronymic===null?"":t.patronymic)+"<\/td><\/tr>";UIMap.personsListTable.append(i)});app.updatePagesLabel();$("#loadingMsg").hide()})},deletePersonClick:function(){let n=$(".table-info");if(n.length===0){alert("Ничего не выделено");return}if(confirm("Удалить данные о клиенте?")){let t=$(n[0]).prop("id");appQuery.deletePerson(t,function(){$("#tableCallsHistory tbody").empty();app.loadPersonsList()})}},pageSizeChange:function(n){appFilters.pageSize=n.value;appFilters.pageNo=1;app.loadPersonsList()},nextPage:function(){appFilters.pageNo>=appState.getPagesCount(appFilters.pageSize)||(appFilters.pageNo++,app.loadPersonsList())},prevPage:function(){appFilters.pageNo!==1&&(appFilters.pageNo--,app.loadPersonsList())},selPerson:function(n){$.each($(".table-info"),function(n,t){$(t).removeClass("table-info")});$(n).addClass("table-info");let t=$(n).prop("id");appState.currentPersonId=t;appState.currentCallId="";appQuery.getPersonData(t,function(n){let i=n.lastName===null?"не указано":n.lastName,r=n.patronymic===null?"не указано":n.patronymic,u=n.gender===1?"М":n.gender===2?"Ж":"не указано",t="не указано";n.birthDate!==null&&(t=n.birthDate.split("T")[0]);$("#detSurname").text(i);$("#detName").text(n.firstName);$("#detPatronymic").text(r);$("#detGender").text(u);$("#detBirthDate").text(t);$("#detPhone").text(n.phoneNumber)});app.updateCalls(t)},updateCalls:function(n){UIMap.personCallsTable.empty();appQuery.getPersonColls(n,function(n){$.each(n,function(n,t){let i=t.callDate.split("T"),r=t.orderCost===null?0:t.orderCost,u="<tr><td>"+i[0]+"<\/td><td>"+t.callReport+"<\/td><td>"+r+"<\/td><td><button type='button' class='btn btn-default btn-sm' data-toggle='modal' data-target='#editCall' id='"+t.callId+"' onclick='app.editCallClick(this)' >Изменить<\/button><\/td><td><button type='button' class='btn btn-danger btn-sm' id='"+t.callId+"' onclick='app.deleteCallClick(this)' >Удалить<\/button><\/td><\/tr>";UIMap.personCallsTable.append(u)})})},addPersonClick:function(){app.clearForm()},clearForm:function(){document.getElementById("frmEditPerson").reset();$("#cMessage").hide();$("#cValidation").hide();$("#currentPersonId").val("")},savePerson:function(){if(!app.formIsValid()){$("#cValidation").show();return}$("#cValidation").hide();let n=$("#cName").val();n||(n=null);let t=$("#cSurname").val();t||(t=null);let i=$("#cPatronymic").val();i||(i=null);let r=$("#cBirthDate").val(),u=$("#cGender").val(),f=$("#cPhoneNumber").val(),e=$("#currentPersonId").val();e?$.ajax({url:"/api/persons",type:"PUT",contentType:"application/json; charset=utf-8",data:JSON.stringify({Id:e,FirstName:n,LastName:t,Patronymic:i,BirthDate:r,PhoneNumber:f,Gender:u}),success:function(){$("#cMessage").show();app.loadPersonsList()},error:function(n,t,i){alert(n+"\n"+t+"\n"+i)}}):$.ajax({url:"/api/persons",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({FirstName:n,LastName:t,Patronymic:i,BirthDate:r,PhoneNumber:f,Gender:u}),success:function(){$("#cMessage").show();app.loadPersonsList()},error:function(n,t,i){alert(n+"\n"+t+"\n"+i)}})},formIsValid:function(){let n=$("#cName").val(),i=$("#cBirthDate").val(),t=$("#cPhoneNumber").val(),r=n&&i&&t,u=n.length>=3&&n.length<=30&&t.length>=5&&t.length<=20&&$("#cSurname").val().length<=30&&$("#cPatronymic").val().length<=30;return r&&u},editPersonClick:function(){if($("#cMessage").hide(),$("#cValidation").hide(),!appState.currentPersonId){alert("Запись не выбрана. При сохранении будет создана новая");$("#btnSavePerson").prop("disabled",!0);return}$("#btnSavePerson").prop("disabled",!1);$("#cName").val($("#detName").text());$("#cSurname").val($("#detSurname").text());$("#cPatronymic").val($("#detPatronymic").text());$("#cBirthDate").val($("#detBirthDate").text());$("#cGender").val($("#detGender").text()==="не указано"?0:$("#detGender").text()==="М"?1:2);$("#cPhoneNumber").val($("#detPhone").text())},callFormIsValid:function(){let t=$("#crCallDate").val(),n=$("#crCallReport").val(),u=$("#crOrderCost").val(),i=n&&t&&appState.currentPersonId,r=n.length<=500&&n.length>=5;return i&&r},clearCallForm:function(){document.getElementById("frmEditCall").reset();$("#crMessage").hide();$("#crValidation").hide();$("#btnSaveCall").prop("disabled",!1)},addCallClick:function(){if(!appState.currentPersonId){alert("Запись не выбрана. Сохранение не возможно");$("#btnSaveCall").prop("disabled",!0);return}app.clearCallForm()},deleteCallClick:function(n){if(confirm("Удалить отчет о звонке?")){let t=appState.currentPersonId,i=$(n).attr("id");$("#currentCallId").val("");$.ajax({url:"/api/persons/"+t+"/calls/"+i,type:"DELETE",contentType:"application/json; charset=utf-8",success:function(){app.updateCalls(t)},error:function(n,t,i){alert(n+"\n"+t+"\n"+i)}})}},editCallClick:function(n){let e=appState.currentPersonId,i=$(n).attr("id");appState.currentCallId=i;let t=$(n).parent().parent().children(),r=$(t[0]).text(),u=$(t[1]).text(),f=$(t[2]).text();$("#crCallDate").val(r);$("#crCallReport").text(u);$("#crOrderCost").val(f);$("#crMessage").hide();$("#crValidation").hide()},saveCall:function(){if(!app.callFormIsValid()){$("#crValidation").show();return}$("#crValidation").hide();let i=$("#crCallDate").val(),r=$("#crCallReport").val(),t=$("#crOrderCost").val();t=isNaN(parseFloat(t))?0:parseFloat(t);let n=appState.currentPersonId,u=appState.currentCallId;u?$.ajax({url:"/api/persons/"+n+"/calls",type:"PUT",contentType:"application/json; charset=utf-8",data:JSON.stringify({CallId:u,PersonId:n,CallReport:r,CallDate:i,OrderCost:t}),success:function(){$("#crMessage").show();app.updateCalls(n);app.currentCallId=""},error:function(n,t,i){alert(n+"\n"+t+"\n"+i)}}):$.ajax({url:"/api/persons/"+n+"/calls",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({PersonId:n,CallReport:r,CallDate:i,OrderCost:t}),success:function(){$("#crMessage").show();app.updateCalls(n);app.currentCallId=""},error:function(n,t,i){alert(n+"\n"+t+"\n"+i)}})}};$(document).ready(function(){app.loadPersonsList()});